<!DOCTYPE html>









<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="读书笔记 —— Libevent源码分析_3" />
<meta property="og:locale" content="en" />
<meta name="description" content="event_add_internal/event_queue_insert/evmap_io_add 本节介绍了Libevent的几个核心函数。首先，event_add函数将event对象添加到注册事件队列中，并将对应的事件注册到事件多路分发器上，主要通过event_add_internal内部函数实现。event_queue_insert函数将事件处理器添加到各种事件队列中。evmap_io_add和evmap_signal_add函数令事件多路分发器监听对应的事件，同时建立文件描述符、信号值与事件处理器之间的映射关系。" />
<meta property="og:description" content="event_add_internal/event_queue_insert/evmap_io_add 本节介绍了Libevent的几个核心函数。首先，event_add函数将event对象添加到注册事件队列中，并将对应的事件注册到事件多路分发器上，主要通过event_add_internal内部函数实现。event_queue_insert函数将事件处理器添加到各种事件队列中。evmap_io_add和evmap_signal_add函数令事件多路分发器监听对应的事件，同时建立文件描述符、信号值与事件处理器之间的映射关系。" />
<link rel="canonical" href="https://fanventory.github.io/posts/Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_3/" />
<meta property="og:url" content="https://fanventory.github.io/posts/Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_3/" />
<meta property="og:site_name" content="Fanventory" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-07-08T14:48:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="读书笔记 —— Libevent源码分析_3" />
<meta name="twitter:site" content="@Fanventory" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-07-08T14:48:00+08:00","datePublished":"2023-07-08T14:48:00+08:00","description":"event_add_internal/event_queue_insert/evmap_io_add 本节介绍了Libevent的几个核心函数。首先，event_add函数将event对象添加到注册事件队列中，并将对应的事件注册到事件多路分发器上，主要通过event_add_internal内部函数实现。event_queue_insert函数将事件处理器添加到各种事件队列中。evmap_io_add和evmap_signal_add函数令事件多路分发器监听对应的事件，同时建立文件描述符、信号值与事件处理器之间的映射关系。","headline":"读书笔记 —— Libevent源码分析_3","mainEntityOfPage":{"@type":"WebPage","@id":"https://fanventory.github.io/posts/Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_3/"},"url":"https://fanventory.github.io/posts/Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_3/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>读书笔记 —— Libevent源码分析_3 | Fanventory
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Fanventory">
<meta name="application-name" content="Fanventory">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  

    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  
    <!--
  Switch the mode between dark and light.
-->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get MODE_ATTR() { return "data-mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }
    static get ID() { return "mode-toggle"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener("change", () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();

      });

    } /* constructor() */

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage({
        direction: ModeToggle.ID,
        message: this.modeStatus
      }, "*");
    }

  } /* ModeToggle */

  const toggle = new ModeToggle();

  function flipMode() {
    if (toggle.hasMode) {
      if (toggle.isSysDarkPrefer) {
        if (toggle.isLightMode) {
          toggle.clearMode();
        } else {
          toggle.setLight();
        }

      } else {
        if (toggle.isDarkMode) {
          toggle.clearMode();
        } else {
          toggle.setDark();
        }
      }

    } else {
      if (toggle.isSysDarkPrefer) {
        toggle.setLight();
      } else {
        toggle.setDark();
      }
    }

    toggle.notify();

  } /* flipMode() */

</script>

  
</head>


  <body data-spy="scroll" data-target="#toc" data-topbar-visible="true">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" class="mx-auto">
        
          
          <img src="/assets/avatar.jpg" alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title">
      <a href="/">Fanventory</a>
    </div>
    <div class="site-subtitle font-italic">琼琼最聪明本人</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    
      <button class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
      <a href="https://github.com/Fanventory" aria-label="github"
        target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/Fanventory" aria-label="twitter"
        target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['zhangzhaofen','aliyun.com'].join('@')" aria-label="email"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper">
  <div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>读书笔记 —— Libevent源码分析_3</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div id="main" class="container pl-xl-4 pr-xl-4">
        





<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4">
    <div class="post pl-1 pr-1 pl-md-2 pr-md-2">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->


<!-- images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  

  
  

  

  
  

  




<!-- Wrap prompt element of blockquote with the <div> tag -->







<!-- return -->

<h1 data-toc-skip>读书笔记 —— Libevent源码分析_3</h1>

<div class="post-meta text-muted">
    <!-- published date -->
    <span>
      Posted
      <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class=""
    data-ts="1688798880"
    data-df="ll"
    data-toggle="tooltip" data-placement="bottom">
  Jul  8, 2023
</em>

    </span>

    <!-- lastmod date -->
    

  

  <div class="d-flex justify-content-between">
    <!-- author(s) -->
    <span>
      

      By

      <em>
      
        
          <a href="https://github.com/fanventory">fanventory</a>
          
        
      
      </em>
    </span>

    <div>
      <!-- page views -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="3520 words">
  <em>19 min</em> read</span>

    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <h1 id="event_add_internalevent_queue_insertevmap_io_add">event_add_internal/event_queue_insert/evmap_io_add</h1>
<blockquote>
  <p>本节介绍了Libevent的几个核心函数。首先，event_add函数将event对象添加到注册事件队列中，并将对应的事件注册到事件多路分发器上，主要通过event_add_internal内部函数实现。event_queue_insert函数将事件处理器添加到各种事件队列中。evmap_io_add和evmap_signal_add函数令事件多路分发器监听对应的事件，同时建立文件描述符、信号值与事件处理器之间的映射关系。</p>
</blockquote>

<p><br />
<br /></p>

<h2 id="event_new"><span class="mr-2">event_new</span><a href="#event_new" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>前面的实例(Libevent源码分析_1)中提到event_new函数的作用的创建一个event对象，该函数位于event.c文件中。event_new函数的实现主要是为event对象分配内存并初始化部分成员，实现相对简单，这里不做讨论。</p>

<h2 id="event_add_internal"><span class="mr-2">event_add_internal</span><a href="#event_add_internal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>event对象创建好之后，应用程序需要调用event_add函数将event对象添加到注册事件队列中，并将对应的事件注册到事件多路分发器上。event_add函数同样位于event.c文件中，主要调用另一个内部函数event_add_internal。</p>

<p>event_add_internal的源码如下：</p>

<div class="language-c++ highlighter-rouge"><div class="code-header">
        <span data-label-text="C++"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">event_add_internal</span><span class="p">(</span><span class="k">struct</span> <span class="nc">event</span> <span class="o">*</span><span class="n">ev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">timeval</span> <span class="o">*</span><span class="n">tv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tv_is_absolute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">event_base</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">notify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="c1">//	对base和ev进行一些调试检测</span>
	<span class="n">EVENT_BASE_ASSERT_LOCKED</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="n">_event_debug_assert_is_setup</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>

	<span class="n">event_debug</span><span class="p">((</span>
		<span class="s">"event_add: event : %p (fd %d), %s%s%scall %p"</span><span class="p">,</span>
		<span class="n">ev</span><span class="p">,</span> 
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_fd</span><span class="p">,</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="n">EV_READ</span> <span class="o">?</span> <span class="s">"EV_READ"</span> <span class="o">:</span> <span class="s">" "</span><span class="p">,</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="n">EV_WRITE</span> <span class="o">?</span> <span class="s">"EV_WRITE"</span> <span class="o">:</span> <span class="s">" "</span><span class="p">,</span>
		<span class="n">tv</span> <span class="o">?</span> <span class="s">"EV_TIMEOUT"</span> <span class="o">:</span> <span class="s">" "</span><span class="p">,</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_calllback</span><span class="p">));</span>

	<span class="n">EVUTIL_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EVLIST_ALL</span><span class="p">));</span>

	<span class="c1">//	如果新添加的事件处理器是定时器，且它尚未被添加到通用定时器队列或时间堆中</span>
	<span class="c1">//	则为该定时器在时间堆上预留一个位置(min_heap_reserve函数作用是扩容)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tv</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_flags</span> <span class="o">&amp;</span> <span class="n">EVLIST_TIMEOUT</span><span class="p">)){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">min_heap_reserve</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">timeheap</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">min_heap_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">timeheap</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>	
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="c1">//	如果当前调用者不是主线程(执行事件循环的线程)，并且被添加的事件处理器是信号事件处理器，而且主线程正在执行该信号事件处理器的回调函数</span>
	<span class="c1">//	则当前调用者必须等待主线程完成调用，否则将引起竞态条件(考虑event结构体的ev_ncalls和ev_pncalls成员)</span>
	<span class="cp">#ifndef _EVENT_DISABLE_THREAD_SUPPORT
</span>		<span class="k">if</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">current_event</span> <span class="o">==</span> <span class="n">ev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="n">EV_SIGNAL</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">EVBASE_IN_THREAD</span><span class="p">(</span><span class="n">base</span><span class="p">)){</span>
			<span class="o">++</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">current_event_waiters</span><span class="p">;</span>	<span class="c1">//	等待事件+1</span>
			<span class="n">EVTHREAD_COND_WAIT</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">current_event_cond</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">th_base_lock</span><span class="p">);</span>	<span class="c1">//	申请条件变量和互斥锁</span>
		<span class="p">}</span>
	<span class="cp">#endif
</span>
	<span class="c1">//	ev是IO事件处理器或信号事件处理器，且没有被插入注册事件队列或活动事件队列</span>
	<span class="c1">//	则绑定事件和事件处理器的映射关系，并加入注册事件队列中</span>
	<span class="k">if</span><span class="p">((</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EV_READ</span> <span class="o">|</span> <span class="n">EV_WRITE</span> <span class="o">|</span> <span class="n">EV_SIGNAL</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EVLIST_INSERTED</span> <span class="o">|</span> <span class="n">EVLIST_ACTIVE</span><span class="p">)){</span>
		<span class="c1">//	添加IO事件和IO事件处理器的映射关系</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EV_READ</span> <span class="o">|</span> <span class="n">EV_WRITE</span><span class="p">))</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">evmap_io_add</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_fd</span><span class="p">,</span> <span class="n">ev</span><span class="p">);</span>
		<span class="c1">//	添加信号事件和信号事件处理器的映射关系</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="n">EV_SIGNAL</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">evmap_signal_add</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_fd</span><span class="p">,</span> <span class="n">ev</span><span class="p">);</span>
		<span class="c1">//	将事件处理器插入注册队列</span>
		<span class="k">if</span><span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">event_queue_insert</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">EVLIST_INSERTED</span><span class="p">);</span>
		<span class="c1">//	事件多路分发器中添加了新的事件，所以要通知主线程</span>
		<span class="k">if</span><span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
			<span class="n">notify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">//	将事件处理器添加到通用定时器队列或时间堆中</span>
	<span class="c1">//	对于信号事件处理器和IO事件处理器，根据evmap_*_add函数的结果决定是否添加(这是为了给事件设置超时)</span>
	<span class="c1">//	对于定时器，始终应该添加之</span>
	<span class="k">if</span><span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">tv</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="k">struct</span> <span class="nc">timeval</span> <span class="n">now</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">common_timeout</span><span class="p">;</span>

		<span class="c1">//	对于永久性事件处理器，如果其超时事件不是绝对时间，则将该事件处理器的超时事件记录在变量ev-&gt;ev_io_timeout中。</span>
		<span class="c1">//	ev_io_timeout是定义在event-internal.h文件中的宏:</span>
		<span class="c1">//	#define ev_io_timeout _ev.ev_io.ev_timeout</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_closure</span> <span class="o">==</span> <span class="n">EV_CLOSURE_PERSIST</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tv_is_absolute</span><span class="p">)</span>
			<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_io_timeout</span> <span class="o">=</span> <span class="o">*</span><span class="n">tv</span><span class="p">;</span>

		<span class="c1">//	如果该事件处理器已经被插入通用定时器队列或时间堆中，则先删除它</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_flags</span> <span class="o">&amp;</span> <span class="n">EVLIST_TIMEOUT</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">min_heap_elt_is_top</span><span class="p">(</span><span class="n">ev</span><span class="p">))</span>
				<span class="n">notify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">event_queue_remove</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">EVLIST_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="c1">//	如果待添加的事件处理器被已经被激活，且原因是超时，则从活动事件队列中删除它，避免其回调函数被执行</span>
		<span class="c1">//	对于信号事件处理器，必要时还需将其ev_ncalls成员设置为0(注意，ev_pncalls如果不为NULL，它指向ev_ncalls)</span>
		<span class="c1">//	ev_ncalls指定其回调函数被执行的次数，将ev_ncalls设置0，可以干净地终止信号事件的处理</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_flags</span> <span class="o">&amp;</span> <span class="n">EVLIST_ACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_res</span> <span class="o">&amp;</span> <span class="n">EV_TIMEOUT</span><span class="p">)){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="n">EV_SIGNAL</span><span class="p">){</span>
				<span class="k">if</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_ncalls</span> <span class="o">&amp;&amp;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_pncalls</span><span class="p">){</span>
					<span class="o">*</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_pncalls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">event_queue_remove</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">EVLIST_ACTIVE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">gettime</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>

		<span class="c1">//	common_timeout用来判断定时器插入通用定时器队列还是时间堆</span>
		<span class="n">common_timeout</span> <span class="o">=</span> <span class="n">is_common_timeout</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">tv_is_absolute</span><span class="p">){</span>
			<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_timeout</span> <span class="o">=</span> <span class="o">*</span><span class="n">tv</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="c1">//	判断应该将定时器插入通用定时器队列还是时间堆</span>
		<span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">common_timeout</span><span class="p">){</span>
			<span class="k">struct</span> <span class="nc">timeval</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tv</span><span class="p">;</span>
			<span class="n">tmp</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">&amp;=</span> <span class="n">MICROSECONDS_MASK</span><span class="p">;</span>
			<span class="n">evutil_timeradd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_timeout</span><span class="p">);</span>
			<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_timeout</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tv</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MICROSECONDS_MASK</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="c1">//	加上当前系统事件，取得定时器的超时绝对时间</span>
		<span class="k">else</span><span class="p">{</span>
			<span class="n">evutil_timeradd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_timeout</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">event_debug</span><span class="p">((</span><span class="s">"event_add: timeout in %d seconds, call %p"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">tv</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_callback</span><span class="p">));</span>

		<span class="c1">//	插入定时器</span>
		<span class="n">event_queue_insert</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">EVLIST_TIMEOUT</span><span class="p">);</span>

		<span class="c1">//	如果被插入的事件处理器是通用定时器队列钟的第一个元素，则通过调用common_timeout_schedule函数将其转移到时间堆钟</span>
		<span class="c1">//	这样通用定时器链表和时间堆钟的定时器就得到了统一的处理</span>
		<span class="k">if</span><span class="p">(</span><span class="n">common_timeout</span><span class="p">){</span>
			<span class="k">struct</span> <span class="nc">common_timeout_list</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> 
				<span class="n">get_common_timeout_list</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_timeout</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ev</span> <span class="o">==</span> <span class="n">TAILQ_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)){</span>
				<span class="n">common_timeout_schedule</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now</span><span class="p">,</span> <span class="n">ev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">min_heap_elt_is_top</span><span class="p">(</span><span class="n">ev</span><span class="p">))</span>
				<span class="n">notify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="c1">//	如果必要，唤醒主线程</span>
		<span class="k">if</span><span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">notify</span> <span class="o">&amp;&amp;</span> <span class="n">EVBASE_NEED_NOTIFY</span><span class="p">(</span><span class="n">base</span><span class="p">))</span>
			<span class="n">evthread_notify_base</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

		<span class="n">_event_debug_note_add</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
		
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>我们总结event_add_internal的过程：</p>

<ol>
  <li>如果新添加的事件处理器是定时器，且未在定时器队列中，则为该定时器预留位置</li>
  <li>如果新添加的事件处理器是信号事件处理器，且主线程正在执行回调函数，则等待主线程完成调用</li>
  <li>如果新添加的事件处理器是IO/信号事件处理器，且没有被插入注册事件队列或活动事件队列，则绑定映射关系，并加入注册事件队列</li>
  <li>将事件处理器添加到通用定时器队列或时间堆中</li>
</ol>

<p><br /></p>

<p>event_add_internal函数内部调用了几个重要的函数：</p>

<ol>
  <li>evmap_io_add</li>
</ol>

<p>该函数将IO事件添加到事件多路分发器中，并将对应的事件处理器添加到IO事件队列中，同时建立IO事件和IO事件处理器之间的映射关系。</p>

<ol>
  <li>evmap_signal_add</li>
</ol>

<p>该函数将信号事件添加到事件多路分发器中，并将对应的事件处理器添加到信号事件队列中，同时建立信号事件和信号事件处理器之间的映射关系。</p>

<ol>
  <li>event_queue_insert</li>
</ol>

<p>该函数将事件处理器添加到各种事件队列中：将IO事件处理器和信号事件处理器插入注册事件队列；将定时器插入通用定时器队列或时间堆；将被激活的事件处理器添加到活动事件队列中。</p>

<p>event_queue_insert的源码如下：</p>

<div class="language-c++ highlighter-rouge"><div class="code-header">
        <span data-label-text="C++"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">event_queue_insert</span><span class="p">(</span><span class="k">struct</span> <span class="nc">event_base</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">event</span> <span class="o">*</span><span class="n">ev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">EVENT_BASE_ASSERT_LOCKED</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="c1">//	避免重复插入</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_flags</span> <span class="o">&amp;</span> <span class="n">queue</span><span class="p">){</span>
		<span class="c1">//	事件已经在活动事件队列中，不重复插入</span>
		<span class="k">if</span><span class="p">(</span><span class="n">queue</span> <span class="o">&amp;</span> <span class="n">EVLIST_ACTIVE</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		
		<span class="c1">//	事件已经在注册事件队列/通用定时器队列/时间堆中，输出错误信息</span>
		<span class="n">event_errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"%s: %p(fd %d) already on queue %x"</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_fd</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">~</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_flags</span> <span class="o">&amp;</span> <span class="n">EVLIST_INTERNAL</span><span class="p">)</span>
		<span class="n">base</span><span class="o">-&gt;</span><span class="n">event_count</span><span class="o">++</span><span class="p">;</span>	<span class="c1">//	将event_base拥有的事件处理器总数+1</span>

	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_flags</span> <span class="o">|=</span> <span class="n">queue</span><span class="p">;</span>	<span class="c1">//	标记该事件已经添加过</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">queue</span><span class="p">){</span>
		<span class="c1">//	将IO事件处理器或信号事件处理器插入注册事件队列</span>
		<span class="k">case</span> <span class="n">EVLIST_INSERTED</span><span class="p">:</span>
			<span class="n">TAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">eventqueue</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">ev_next</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="c1">//	将就绪事件处理器插入活动事件队列</span>
		<span class="k">case</span> <span class="n">EVLIST_ACTIVE</span><span class="p">:</span>
			<span class="n">base</span><span class="o">-&gt;</span><span class="n">event_count_active</span><span class="o">++</span><span class="p">;</span>
			<span class="n">TAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">activequeue</span><span class="p">[</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_pri</span><span class="p">],</span> <span class="n">ev</span><span class="p">,</span> <span class="n">ev_active_next</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="c1">//	将定时器插入通用定时器队列或时间堆</span>
		<span class="k">case</span> <span class="n">EVLIST_TIMEOUT</span><span class="p">:{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">is_common_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_timeout</span><span class="p">,</span> <span class="n">base</span><span class="p">)){</span>
				<span class="k">struct</span> <span class="nc">common_timeout_list</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> 
					<span class="n">get_common_timeout_list</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_timeout</span><span class="p">);</span>
					<span class="n">insert_common_timeout_inorder</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="n">ev</span><span class="p">);</span>
			<span class="p">}</span><span class="k">else</span>
				<span class="nf">min_heap_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">timeheap</span><span class="p">,</span> <span class="n">ev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">default</span><span class="o">:</span>
			<span class="n">event_errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"%s: unkown queue %x"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>我们总结event_queue_insert的过程：</p>

<ol>
  <li>判断事件是否已经在队列中，避免重复插入</li>
  <li>根据事件处理器的类型，插入到注册事件队列/活动事件队列/通用定时器队列或时间堆</li>
</ol>

<h2 id="evmapc中的一些数据结构"><span class="mr-2">evmap.c中的一些数据结构</span><a href="#evmapc中的一些数据结构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>evmap_io_add和evmap_signal_add会让事件多路分发器监听对应的事件，同时建立文件描述符、信号值与事件处理器之间的映射关系。</p>

<p>在介绍evmap_io_add和evmap_signal_add方法之前，我们先介绍一些这两个函数用到的一些重要的数据结构：</p>

<div class="language-c++ highlighter-rouge"><div class="code-header">
        <span data-label-text="C++"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="cp">#ifdef MVMAP_USE_HT
#include</span> <span class="cpf">"ht-internal.h"</span><span class="cp">
</span>
<span class="k">struct</span> <span class="nc">event_map_entry</span><span class="p">;</span>

<span class="cm">/*
如果定义了MVMAP_USE_HT，则将event_io_map定义为哈希表，该哈希表存储event_map_entry对象和IO事件队列(相同文件描述符值的IO事件处理器构成IO事件队列)之间的映射关系，实际上也就是存储了文件描述符和IO事件处理器之间的映射关系
*/</span>
<span class="n">HT_HEAD</span><span class="p">(</span><span class="n">event_io_map</span><span class="p">,</span> <span class="n">event_map_entry</span><span class="p">);</span>
<span class="cp">#else	//	否则event_io_map的结构和event_signal_map相同
#define event_io_map event_signal_map
#endif
</span>
<span class="c1">//	下面这个结构体中的entries数组成员存储信号值和信号事件处理器之间的映射关系(用信号值索引数组entries)</span>
<span class="k">struct</span> <span class="nc">event_signal_map</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">**</span><span class="n">entries</span><span class="p">;</span>	<span class="c1">//	用于存放evmap_io或evmap_signal数组</span>
	<span class="kt">int</span> <span class="n">nentries</span><span class="p">;</span>	<span class="c1">//	entries数组的大小</span>
<span class="p">};</span>

<span class="c1">//	如果定义了EVMAP_USE_HT，则哈希表event_io_map中的成员具有如下类型</span>
<span class="k">struct</span> <span class="nc">event_map_entry</span>
<span class="p">{</span>
	<span class="n">HT_ENTRY</span><span class="p">(</span><span class="n">event_map_entry</span><span class="p">)</span> <span class="n">map_node</span><span class="p">;</span>
	<span class="n">evutil_socket_t</span> <span class="n">fd</span><span class="p">;</span>
	<span class="k">union</span><span class="p">{</span>
		<span class="k">struct</span> <span class="nc">evmap_io</span> <span class="n">evmap_io</span><span class="p">;</span>
	<span class="p">}</span><span class="n">ent</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">//	event_list是由event组成的尾队列</span>
<span class="n">TAILQ_HEAD</span><span class="p">(</span><span class="n">event_list</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

<span class="c1">//	IO事件队列类</span>
<span class="k">struct</span> <span class="nc">evmap_io</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">event_list</span> <span class="n">events</span><span class="p">;</span>	<span class="c1">//	IO事件队列</span>
	<span class="n">ev_uint16_t</span> <span class="n">nread</span><span class="p">;</span>
	<span class="n">ev_uint16_t</span> <span class="n">nwrite</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">//	信号事件队列类</span>
<span class="k">struct</span> <span class="nc">evmap_signal</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="nc">event_list</span> <span class="n">events</span><span class="p">;</span>	<span class="c1">//	信号事件队列</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="evmap_io_add和evmap_signal_add"><span class="mr-2">evmap_io_add和evmap_signal_add</span><a href="#evmap_io_add和evmap_signal_add" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>evmap_io_add和evmap_signal_add的逻辑基本相同，所以我们仅讨论其中一个。</p>

<p>evmap_io_add的源码如下：</p>

<div class="language-c++ highlighter-rouge"><div class="code-header">
        <span data-label-text="C++"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">evmap_io_add</span><span class="p">(</span><span class="k">struct</span> <span class="nc">event_base</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="n">evutil_socket_t</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">event</span> <span class="o">*</span><span class="n">ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//	获得event_base的后端IO复用机制实例</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="nc">eventop</span> <span class="o">*</span><span class="n">evsel</span> <span class="o">=</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">evsel</span><span class="p">;</span>
	<span class="c1">//	获得event_base中文件描述符和IO事件队列的映射表(哈希表或数组)</span>
	<span class="k">struct</span> <span class="nc">event_io_map</span> <span class="o">*</span><span class="n">io</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">;</span>
	<span class="c1">//	fd参数对应的IO事件队列</span>
	<span class="k">struct</span> <span class="nc">evmap_io</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nread</span><span class="p">,</span> <span class="n">nwrite</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="nc">event</span> <span class="o">*</span><span class="n">old_ev</span><span class="p">;</span>

	<span class="n">EVUTIL_ASSERT</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_fd</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifndef EVMAP_USE_HT
</span>	<span class="c1">//	IO事件队列数组io.entries中，每个文件描述符占一项，如果fd大于当前数组的大小，则进行扩容</span>
	<span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">nentries</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">evmap_make_space</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">evmap_io</span><span class="o">*</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif
</span>	<span class="c1">//	下面这个宏根据EVMAP_USE_HT是否被定义而又不同的实现，但目的都是创建ctx，在映射表io中为fd和ctx添加映射关系</span>
	<span class="n">GET_IO_SLOT_AND_CTOR</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">evmap_io</span><span class="p">,</span> <span class="n">evmap_io_init</span><span class="p">,</span> <span class="n">evsel</span><span class="o">-&gt;</span><span class="n">fdinfo_len</span><span class="p">);</span>

	<span class="n">nread</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">nread</span><span class="p">;</span>
	<span class="n">nwrite</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">nwrite</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">nread</span><span class="p">)</span>
		<span class="n">old</span> <span class="o">|=</span> <span class="n">EV_READ</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">nwrite</span><span class="p">)</span>
		<span class="n">old</span> <span class="o">|=</span> <span class="n">EV_WRITE</span><span class="p">;</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="n">EV_READ</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="n">nread</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">|=</span> <span class="n">EV_READ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="n">EV_WRITE</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="n">nwrite</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">|=</span> <span class="n">EV_WRITE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">EVUTIL_UNLIKELY</span><span class="p">(</span><span class="n">nread</span> <span class="o">&gt;</span> <span class="mh">0xffff</span> <span class="o">||</span> <span class="n">nwrite</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)){</span>
		<span class="n">event_warnx</span><span class="p">(</span><span class="s">"Too many events reading or writing on fd %d"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">EVENT_DEBUG_MODE_IS_ON</span><span class="p">()</span> <span class="o">&amp;&amp;</span> 
		<span class="p">(</span><span class="n">old_ev</span> <span class="o">=</span> <span class="n">TAILQ_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">old_ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="n">EV_ET</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="n">EV_ET</span><span class="p">)){</span>
		<span class="n">event_warnx</span><span class="p">(</span><span class="s">"Tried to mix edge-triggered and non-edge-triggered events on fd %d"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">res</span><span class="p">){</span>
		<span class="c1">//	获取IO事件队列的内存地址</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">extra</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">evmap_io</span><span class="p">));</span>
		<span class="c1">//	往事件多路分发器中注册事件</span>
		<span class="c1">//	add是事件多路分发器的接口函数之一。对不同的后端IO复用机制，这些接口函数有不同的实现</span>
		<span class="k">if</span><span class="p">(</span><span class="n">evsel</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_fd</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> 
			<span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ev_events</span> <span class="o">&amp;</span> <span class="n">EV_ET</span><span class="p">)</span> <span class="o">|</span> <span class="n">res</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">nread</span> <span class="o">=</span> <span class="p">(</span><span class="n">ev_uint16_t</span><span class="p">)</span><span class="n">nread</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">nwrite</span> <span class="o">=</span> <span class="p">(</span><span class="n">ev_uint16_t</span><span class="p">)</span><span class="n">nwrite</span><span class="p">;</span>
	<span class="c1">//	将ev插到IO事件队列ctx的尾部，ev_io_next是定义在event-internal.h文件中的宏：</span>
	<span class="c1">//	#define ev_io_next _ev.ev_io.ev_io_next</span>
	<span class="n">TAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">ev_io_next</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>我们总结evmap_io_add的过程：</p>

<ol>
  <li>获取IO复用机制的接口</li>
  <li>获取IO事件队列的映射表</li>
  <li>判断IO事件队列空间是否足够，如果不够则扩容</li>
  <li>获得fd对应的IO事件队列，并添加映射关系</li>
  <li>添加可读、可写事件类型等属性</li>
  <li>注册事件</li>
  <li>插入IO事件队列</li>
</ol>

<h2 id="总结"><span class="mr-2">总结</span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<blockquote>
  <ul>
    <li>event_new函数的实现主要是为event对象分配内存并初始化部分成员，该函数位于event.c文件中</li>
    <li>event_add函数将event对象添加到注册事件队列中，并将对应的事件注册到事件多路分发器上，该函数位于event.c文件中</li>
    <li>event_queue_insert函数将事件处理器添加到各种事件队列中：将IO事件处理器和信号事件处理器插入注册事件队列；将定时器插入通用定时器队列或时间堆；将被激活的事件处理器添加到活动事件队列中</li>
    <li>evmap_io_add和evmap_signal_add函数令事件多路分发器监听对应的事件，同时建立文件描述符、信号值与事件处理器之间的映射关系</li>
  </ul>
</blockquote>

<h1 id="reference">Reference</h1>
<p>[1] 《深入解析高性能服务器编程》</p>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/reading-notes/'>Reading Notes</a>,
      <a href='/categories/linux%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/'>Linux高性能服务器编程</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/c/"
          class="post-tag no-text-decoration" >C++</a>
      
      <a href="/tags/libevent/"
          class="post-tag no-text-decoration" >Libevent</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0+%E2%80%94%E2%80%94+Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_3+-+Fanventory&url=https%3A%2F%2Ffanventory.github.io%2Fposts%2FLibevent%25E6%25BA%2590%25E7%25A0%2581%25E5%2588%2586%25E6%259E%2590_3%2F" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0+%E2%80%94%E2%80%94+Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_3+-+Fanventory&u=https%3A%2F%2Ffanventory.github.io%2Fposts%2FLibevent%25E6%25BA%2590%25E7%25A0%2581%25E5%2588%2586%25E6%259E%2590_3%2F" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://t.me/share/url?url=https%3A%2F%2Ffanventory.github.io%2Fposts%2FLibevent%25E6%25BA%2590%25E7%25A0%2581%25E5%2588%2586%25E6%259E%2590_3%2F&text=%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0+%E2%80%94%E2%80%94+Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_3+-+Fanventory" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        data-title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- panel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/c/">C++</a>
    
      
      <a class="post-tag" href="/tags/leetcode/">leetcode</a>
    
      
      <a class="post-tag" href="/tags/reading-notes/">Reading Notes</a>
    
      
      <a class="post-tag" href="/tags/dynamic-programming/">Dynamic Programming</a>
    
      
      <a class="post-tag" href="/tags/template/">template</a>
    
      
      <a class="post-tag" href="/tags/pthread/">Pthread</a>
    
      
      <a class="post-tag" href="/tags/socket/">socket</a>
    
      
      <a class="post-tag" href="/tags/libevent/">Libevent</a>
    
      
      <a class="post-tag" href="/tags/multiprocess/">Multiprocess</a>
    
      
      <a class="post-tag" href="/tags/io%E5%A4%8D%E7%94%A8/">IO复用</a>
    

    </div>
  </div>


    </div>

    
      
      



<!-- BS-toc.js will be loaded at medium priority -->
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
  <nav id="toc" data-toggle="toc"></nav>
</div>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5">
    
      
      <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->





  <div id="related-posts" class="mb-2 mb-sm-4">
    <h3 class="pt-2 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_1/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1688712660"
    data-df="ll"
    >
  Jul  7, 2023
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>读书笔记 —— Libevent源码分析_1</h3>
            <div class="text-muted small">
              <p>
                





                Libevent安装/Libevent简单实例

  Libevent是一款开源的高性能IO框架库，具有支持跨平台、统一事件源、线程安全、基于Reacotr模式的实现的特点。我们给出了Libevent的安装步骤，通过一个简单的例子来展示Libevent的用法。





Libevent

Libevent是一款开源的高性能IO框架库，使用Libevent的案例包括：高性能的分布式内存对象缓...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_2/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1688717940"
    data-df="ll"
    >
  Jul  7, 2023
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>读书笔记 —— Libevent源码分析_2</h3>
            <div class="text-muted small">
              <p>
                





                Libevent源代码组织结构/event

  本节我们继续探究Libevent的源码，在分析具体源码之前，我们先分析了Libevent的组织结构，弄清楚每个目录及文件实现了什么功能。接着我们把重点放在event和event_base这两个结构体及其相关操作上，它们构成了Libevent框架的基础。最后我们分析了event结构体的成员，为之后分析event结构体相关联的操作做准备。



...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_4/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->





<em class="small"
    data-ts="1688885760"
    data-df="ll"
    >
  Jul  9, 2023
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>读书笔记 —— Libevent源码分析_4</h3>
            <div class="text-muted small">
              <p>
                





                eventop/event_base

  本节介绍了Libevent中两个重要的结构体。第一个是eventop结构体，它封装了IO复用机制的一些必要操作，目的是为event_base提供统一的IO复用接口。Libevent会检测当前系统支持IO复用机制，如果存在多种支持的IO复用机制，则根据eventops数组中的优先级来选取。第二个是event_base结构体，它是Libevent的Re...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


    
      
      <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_2/" class="btn btn-outline-primary"
    prompt="Older">
    <p>读书笔记 —— Libevent源码分析_2</p>
  </a>
  

  
  <a href="/posts/Libevent%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_4/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>读书笔记 —— Libevent源码分析_4</p>
  </a>
  

</div>

    
      
      <!--  The comments switcher -->


    
  </div>
</div>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/c/">C++</a>
    
      
      <a class="post-tag" href="/tags/leetcode/">leetcode</a>
    
      
      <a class="post-tag" href="/tags/reading-notes/">Reading Notes</a>
    
      
      <a class="post-tag" href="/tags/dynamic-programming/">Dynamic Programming</a>
    
      
      <a class="post-tag" href="/tags/template/">template</a>
    
      
      <a class="post-tag" href="/tags/pthread/">Pthread</a>
    
      
      <a class="post-tag" href="/tags/socket/">socket</a>
    
      
      <a class="post-tag" href="/tags/libevent/">Libevent</a>
    
      
      <a class="post-tag" href="/tags/multiprocess/">Multiprocess</a>
    
      
      <a class="post-tag" href="/tags/io%E5%A4%8D%E7%94%A8/">IO复用</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    <!-- The Footer -->

<footer>
  <div class="container pl-lg-4 pr-lg-4">
    <div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3">
      <div class="footer-left">
        <p class="mb-0">
          © 2025
          <a href="https://twitter.com/username">Fanventory</a>.
          
          <span data-toggle="tooltip" data-placement="top"
            title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
          
        </p>
      </div>

      <div class="footer-right">
        <p class="mb-0">

          

          

          Powered by 
          <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
           with 
          <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>
           theme.
        </p>
      </div>
    </div>
  </div>
</footer>


    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    
      <div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
        data-animation="true" data-autohide="false">
        <div class="toast-header">
          <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body text-center pt-0">
          <p class="pl-2 pr-2 mb-3">A new version of content is available.</p>
          <button type="button" class="btn btn-primary" aria-label="Update">
            Update
          </button>
        </div>
      </div>
    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No results found.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script>







  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script>








<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>

